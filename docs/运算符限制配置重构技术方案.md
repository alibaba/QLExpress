# è¿ç®—ç¬¦é™åˆ¶é…ç½®é‡æ„æŠ€æœ¯æ–¹æ¡ˆ

## 1. åŠŸèƒ½æ¦‚è¿°

### åŠŸèƒ½ç›®æ ‡
å°†è¿ç®—ç¬¦é»‘ç™½åå•é…ç½®ä» `InitOptions` ä¸­åˆ†ç¦»å‡ºæ¥,åˆ›å»ºç‹¬ç«‹çš„ `CheckOptions` é…ç½®ç±»,å®ç°é…ç½®èŒè´£çš„æ¸…æ™°åˆ†ç¦»ã€‚

### é€‚ç”¨åœºæ™¯
- éœ€è¦å¯¹è„šæœ¬ä¸­ä½¿ç”¨çš„è¿ç®—ç¬¦è¿›è¡Œé™åˆ¶çš„åœºæ™¯
- éœ€è¦åœ¨ä¸åŒåœºæ™¯ä¸‹ä½¿ç”¨ä¸åŒè¿ç®—ç¬¦é™åˆ¶ç­–ç•¥çš„åœºæ™¯
- éœ€è¦åœ¨è¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´è¿ç®—ç¬¦é™åˆ¶çš„åœºæ™¯

### æ”¹åŠ¨èŒƒå›´æ¦‚è¦
- ğŸŸ¢ æ–°å¢ `CheckOptions` ç±»
- ğŸŸ¡ ä¿®æ”¹ `Express4Runner.check()` æ–¹æ³•
- ğŸŸ¡ ä¿®æ”¹ `OperatorVisitor` æ„é€ å‡½æ•°
- ğŸŸ¡ æ›´æ–°æµ‹è¯•ç”¨ä¾‹ `OperatorLimitTest`

## 2. æŠ€æœ¯å…³é”®ç‚¹

### èŒè´£åˆ†ç¦»
- **InitOptions**: è´Ÿè´£ Express4Runner çš„å…¨å±€åˆå§‹åŒ–é…ç½®(ç±»åŠ è½½ã€å®‰å…¨ç­–ç•¥ã€è°ƒè¯•æ¨¡å¼ç­‰)
- **CheckOptions**: ä¸“é—¨è´Ÿè´£è„šæœ¬æ ¡éªŒæ—¶çš„è¿ç®—ç¬¦é™åˆ¶é…ç½®(ç™½åå•/é»‘åå•)

### å‘åå…¼å®¹
- ä¿ç•™ `Express4Runner.check(String script)` æ— å‚ç‰ˆæœ¬,ä½¿ç”¨é»˜è®¤é…ç½®
- æ–°å¢ `Express4Runner.check(String script, CheckOptions checkOptions)` é‡è½½æ–¹æ³•

## 3. è¯¦ç»†è®¾è®¡

### 3.1 å®ç°æ€è·¯

#### æ•´ä½“æµç¨‹
1. ç”¨æˆ·åˆ›å»º `CheckOptions` é…ç½®å¯¹è±¡,è®¾ç½®è¿ç®—ç¬¦ç™½åå•æˆ–é»‘åå•
2. è°ƒç”¨ `Express4Runner.check(script, checkOptions)` è¿›è¡Œè„šæœ¬æ ¡éªŒ
3. `check` æ–¹æ³•å†…éƒ¨åˆ›å»º `OperatorVisitor`,ä¼ å…¥ `CheckOptions`
4. `OperatorVisitor` éå†è¯­æ³•æ ‘,æ ¡éªŒæ¯ä¸ªè¿ç®—ç¬¦æ˜¯å¦ç¬¦åˆé™åˆ¶è§„åˆ™
5. å¦‚æœå‘ç°è¿è§„è¿ç®—ç¬¦,ç«‹å³æŠ›å‡º `QLSyntaxException`

#### æ¨¡å—åˆ’åˆ†
- **CheckOptions**: é…ç½®ç±»,å°è£…è¿ç®—ç¬¦é™åˆ¶è§„åˆ™
- **Express4Runner**: å…¥å£ç±»,æä¾› check æ–¹æ³•
- **OperatorVisitor**: æ ¡éªŒå™¨,æ‰§è¡Œå®é™…çš„è¿ç®—ç¬¦æ ¡éªŒé€»è¾‘

### 3.2 æ¶æ„å›¾è¡¨

#### ç±»å›¾

```mermaid
classDiagram
    class CheckOptions {
        -Set~Operator~ allowedOperators
        -Set~Operator~ forbiddenOperators
        +DEFAULT_OPTIONS: CheckOptions
        +builder() Builder
        +getAllowedOperators() Set~Operator~
        +getForbiddenOperators() Set~Operator~
    }

    class CheckOptionsBuilder {
        -Set~Operator~ allowedOperators
        -Set~Operator~ forbiddenOperators
        +allowedOperators(Set~Operator~) Builder
        +forbiddenOperators(Set~Operator~) Builder
        +build() CheckOptions
    }

    class Express4Runner {
        +check(String script, CheckOptions) void
        +check(String script) void
    }

    class OperatorVisitor {
        -Set~Operator~ allowedOperators
        -Set~Operator~ forbiddenOperators
        -Set~String~ allowedOperatorStrings
        -Set~String~ forbiddenOperatorStrings
        +OperatorVisitor(CheckOptions)
        -checkOperator(String) void
        +visitLeftAsso(LeftAssoContext) Void
        +visitPrefixExpress(PrefixExpressContext) Void
        +visitSuffixExpress(SuffixExpressContext) Void
        +visitExpression(ExpressionContext) Void
    }

    CheckOptions "1" --o "1" CheckOptionsBuilder : creates
    Express4Runner ..> CheckOptions : uses
    Express4Runner ..> OperatorVisitor : creates
    OperatorVisitor ..> CheckOptions : uses

    style CheckOptions fill:#d5e8d4,stroke:#82b366,stroke-width:2px
    style CheckOptionsBuilder fill:#d5e8d4,stroke:#82b366,stroke-width:2px
    style Express4Runner fill:#fff2cc,stroke:#d6b656,stroke-width:2px
    style OperatorVisitor fill:#fff2cc,stroke:#d6b656,stroke-width:2px
```

#### å˜æ›´å¯¹æ¯”æµç¨‹å›¾

```mermaid
graph TD
    subgraph "å˜æ›´å‰"
        A1[ç”¨æˆ·] --> B1[åˆ›å»º InitOptions<br/>è®¾ç½®è¿ç®—ç¬¦é™åˆ¶]
        B1 --> C1[åˆ›å»º Express4Runner]
        C1 --> D1[è°ƒç”¨ checkæ–¹æ³•]
        D1 --> E1[OperatorVisitor<br/>ä» InitOptions è·å–é…ç½®]
    end

    subgraph "å˜æ›´å"
        A2[ç”¨æˆ·] --> B2[ğŸŸ¢ åˆ›å»º CheckOptions<br/>è®¾ç½®è¿ç®—ç¬¦é™åˆ¶]
        B2 --> C2[åˆ›å»º Express4Runner<br/>ä½¿ç”¨ InitOptions]
        C2 --> D2[ğŸŸ¡ è°ƒç”¨ checkæ–¹æ³•<br/>ä¼ å…¥ CheckOptions]
        D2 --> E2[ğŸŸ¡ OperatorVisitor<br/>ä» CheckOptions è·å–é…ç½®]
    end

    style B2 fill:#d5e8d4,stroke:#82b366,stroke-width:2px
    style D2 fill:#fff2cc,stroke:#d6b656,stroke-width:2px
    style E2 fill:#fff2cc,stroke:#d6b656,stroke-width:2px
```

#### å˜æ›´å½±å“å›¾

```mermaid
graph LR
    subgraph "æ ¸å¿ƒå˜æ›´"
        A[ğŸŸ¢ CheckOptions]
    end

    subgraph "ç›´æ¥å½±å“"
        B[ğŸŸ¡ Express4Runner.check]
        C[ğŸŸ¡ OperatorVisitor]
    end

    subgraph "é—´æ¥å½±å“"
        D[OperatorLimitTest]
    end

    A --> B
    A --> C
    B --> D
    C --> D

    style A fill:#d5e8d4,stroke:#82b366,stroke-width:3px
    style B fill:#fff2cc,stroke:#d6b656,stroke-width:2px
    style C fill:#fff2cc,stroke:#d6b656,stroke-width:2px
```

### 3.3 å…³é”®ä»£ç ç¤ºä¾‹

#### CheckOptions ç±»è®¾è®¡

```java
public class CheckOptions {
    private final Set<Operator> allowedOperators;
    private final Set<Operator> forbiddenOperators;

    public static final CheckOptions DEFAULT_OPTIONS = new CheckOptions(null, null);

    private CheckOptions(Set<Operator> allowedOperators, Set<Operator> forbiddenOperators) {
        // æ ¡éªŒ:ç™½åå•å’Œé»‘åå•ä¸èƒ½åŒæ—¶è®¾ç½®
        if (allowedOperators != null && !allowedOperators.isEmpty()
            && forbiddenOperators != null && !forbiddenOperators.isEmpty()) {
            throw new IllegalArgumentException("ä¸èƒ½åŒæ—¶è®¾ç½®ç™½åå•å’Œé»‘åå•");
        }

        this.allowedOperators = allowedOperators != null ?
            Collections.unmodifiableSet(allowedOperators) : null;
        this.forbiddenOperators = forbiddenOperators != null ?
            Collections.unmodifiableSet(forbiddenOperators) : null;
    }

    public static Builder builder() {
        return new Builder();
    }

    public static class Builder {
        private Set<Operator> allowedOperators;
        private Set<Operator> forbiddenOperators;

        public Builder allowedOperators(Set<Operator> allowedOperators) {
            this.allowedOperators = allowedOperators;
            return this;
        }

        public Builder forbiddenOperators(Set<Operator> forbiddenOperators) {
            this.forbiddenOperators = forbiddenOperators;
            return this;
        }

        public CheckOptions build() {
            return new CheckOptions(allowedOperators, forbiddenOperators);
        }
    }
}
```

#### Express4Runner.check æ–¹æ³•ç­¾å

```java
// æ–°å¢:æ¥æ”¶ CheckOptions å‚æ•°
public void check(String script, CheckOptions checkOptions) throws QLSyntaxException {
    QLParser.ProgramContext programContext = parseToSyntaxTree(script);
    OperatorVisitor operatorVisitor = new OperatorVisitor(checkOptions);
    programContext.accept(operatorVisitor);
}

// ä¿ç•™:å‘åå…¼å®¹
public void check(String script) throws QLSyntaxException {
    check(script, CheckOptions.DEFAULT_OPTIONS);
}
```

#### OperatorVisitor æ„é€ å‡½æ•°

```java
public OperatorVisitor(CheckOptions checkOptions) {
    if (checkOptions == null) {
        checkOptions = CheckOptions.DEFAULT_OPTIONS;
    }

    this.allowedOperators = checkOptions.getAllowedOperators();
    this.forbiddenOperators = checkOptions.getForbiddenOperators();

    // è½¬æ¢ä¸ºå­—ç¬¦ä¸²é›†åˆç”¨äºå¿«é€ŸæŸ¥æ‰¾
    this.allowedOperatorStrings = (allowedOperators != null && !allowedOperators.isEmpty()) ?
        allowedOperators.stream()
            .map(Operator::getOperator)
            .collect(Collectors.toSet()) : null;

    this.forbiddenOperatorStrings = (forbiddenOperators != null && !forbiddenOperators.isEmpty()) ?
        forbiddenOperators.stream()
            .map(Operator::getOperator)
            .collect(Collectors.toSet()) : null;
}
```

## 4. ä½¿ç”¨ç¤ºä¾‹

### ç™½åå•æ¨¡å¼

```java
// åˆ›å»ºç™½åå•é…ç½®
Set<Operator> allowedOps = new HashSet<>(Arrays.asList(
    PlusOperator.getInstance(),
    MultiplyOperator.getInstance()
));

CheckOptions checkOptions = CheckOptions.builder()
    .allowedOperators(allowedOps)
    .build();

// ä½¿ç”¨é…ç½®è¿›è¡Œæ ¡éªŒ
Express4Runner runner = new Express4Runner(InitOptions.DEFAULT_OPTIONS);
runner.check("a + b * c", checkOptions);  // âœ… é€šè¿‡
runner.check("a = b + c", checkOptions);  // âŒ æŠ›å‡ºå¼‚å¸¸:ä½¿ç”¨äº†ä¸å…è®¸çš„è¿ç®—ç¬¦ =
```

### é»‘åå•æ¨¡å¼

```java
// åˆ›å»ºé»‘åå•é…ç½®
Set<Operator> forbiddenOps = new HashSet<>(Arrays.asList(
    AssignOperator.getInstance()
));

CheckOptions checkOptions = CheckOptions.builder()
    .forbiddenOperators(forbiddenOps)
    .build();

// ä½¿ç”¨é…ç½®è¿›è¡Œæ ¡éªŒ
Express4Runner runner = new Express4Runner(InitOptions.DEFAULT_OPTIONS);
runner.check("a + b * c", checkOptions);  // âœ… é€šè¿‡
runner.check("a = b + c", checkOptions);  // âŒ æŠ›å‡ºå¼‚å¸¸:ä½¿ç”¨äº†è¢«ç¦æ­¢çš„è¿ç®—ç¬¦ =
```

### æ— é™åˆ¶æ¨¡å¼

```java
// ä¸ä¼ å…¥ CheckOptions æˆ–ä½¿ç”¨é»˜è®¤é…ç½®
Express4Runner runner = new Express4Runner(InitOptions.DEFAULT_OPTIONS);
runner.check("a = b + c");  // âœ… é€šè¿‡,ä¸è¿›è¡Œä»»ä½•é™åˆ¶
```

## 5. æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹è¦†ç›–

| æµ‹è¯•ç”¨ä¾‹ | æè¿° | çŠ¶æ€ |
|---------|------|------|
| testCheckWithAllowedOperators | ç™½åå•æ¨¡å¼ - å…è®¸çš„è¿ç®—ç¬¦å¯ä»¥æ­£å¸¸ä½¿ç”¨ | âœ… é€šè¿‡ |
| testCheckWithDisallowedOperators | ç™½åå•æ¨¡å¼ - ä½¿ç”¨ä¸å…è®¸çš„è¿ç®—ç¬¦ä¼šæŠ›å‡ºå¼‚å¸¸ | âœ… é€šè¿‡ |
| testCheckWithForbiddenOperators | é»‘åå•æ¨¡å¼ - ä¸åœ¨é»‘åå•ä¸­çš„è¿ç®—ç¬¦å¯ä»¥æ­£å¸¸ä½¿ç”¨ | âœ… é€šè¿‡ |
| testCheckWithForbiddenOperatorUsed | é»‘åå•æ¨¡å¼ - ä½¿ç”¨è¢«ç¦æ­¢çš„è¿ç®—ç¬¦ä¼šæŠ›å‡ºå¼‚å¸¸ | âœ… é€šè¿‡ |
| testCheckWithoutLimit | æ— é™åˆ¶æ¨¡å¼ - ä»»ä½•è¿ç®—ç¬¦éƒ½å¯ä»¥ä½¿ç”¨ | âœ… é€šè¿‡ |
| testCannotSetBothWhitelistAndBlacklist | ç™½åå•å’Œé»‘åå•ä¸èƒ½åŒæ—¶è®¾ç½® | âœ… é€šè¿‡ |

### æµ‹è¯•ç»“æœ

```
Tests run: 6, Failures: 0, Errors: 0, Skipped: 0
```

## 6. ä¼˜åŠ¿ä¸æ”¶ç›Š

### èŒè´£åˆ†ç¦»
- `InitOptions`: ä¸“æ³¨äº Express4Runner çš„å…¨å±€åˆå§‹åŒ–é…ç½®
- `CheckOptions`: ä¸“æ³¨äºè„šæœ¬æ ¡éªŒæ—¶çš„è¿ç®—ç¬¦é™åˆ¶é…ç½®
- ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™(SRP)

### çµæ´»æ€§æå‡
- å¯ä»¥åœ¨ä¸åŒçš„ check è°ƒç”¨ä¸­ä½¿ç”¨ä¸åŒçš„è¿ç®—ç¬¦é™åˆ¶ç­–ç•¥
- æ— éœ€é‡æ–°åˆ›å»º Express4Runner å®ä¾‹å³å¯åˆ‡æ¢é™åˆ¶è§„åˆ™

### å‘åå…¼å®¹
- ä¿ç•™äº† `check(String script)` æ— å‚ç‰ˆæœ¬
- ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯ç»§ç»­ä½¿ç”¨

### ä»£ç æ¸…æ™°åº¦
- é…ç½®æ„å›¾æ›´åŠ æ˜ç¡®:CheckOptions ä¸“é—¨ç”¨äºæ ¡éªŒé…ç½®
- é™ä½äº† InitOptions çš„å¤æ‚åº¦

## 7. æ³¨æ„äº‹é¡¹

1. **ç™½åå•å’Œé»‘åå•äº’æ–¥**: ä¸èƒ½åŒæ—¶è®¾ç½®,å¦åˆ™ä¼šæŠ›å‡º `IllegalArgumentException`
2. **é»˜è®¤è¡Œä¸º**: å¦‚æœä¸ä¼ å…¥ CheckOptions æˆ–ä½¿ç”¨ `DEFAULT_OPTIONS`,åˆ™ä¸è¿›è¡Œä»»ä½•è¿ç®—ç¬¦é™åˆ¶
3. **ä¸å¯å˜æ€§**: CheckOptions ä¸­çš„é›†åˆæ˜¯ä¸å¯å˜çš„,ä¿è¯çº¿ç¨‹å®‰å…¨
4. **æ€§èƒ½è€ƒè™‘**: è¿ç®—ç¬¦å­—ç¬¦ä¸²é›†åˆåœ¨æ„é€ æ—¶é¢„å…ˆè½¬æ¢,é¿å…è¿è¡Œæ—¶é‡å¤è½¬æ¢

## 8. åç»­ä¼˜åŒ–å»ºè®®

1. **é¢„å®šä¹‰é…ç½®**: å¯ä»¥æä¾›ä¸€äº›å¸¸ç”¨çš„é¢„å®šä¹‰é…ç½®,å¦‚ `CheckOptions.SAFE_MODE`(åªå…è®¸å®‰å…¨è¿ç®—ç¬¦)
2. **é…ç½®ç»„åˆ**: æ”¯æŒå¤šä¸ª CheckOptions çš„ç»„åˆ,å®ç°æ›´çµæ´»çš„é™åˆ¶ç­–ç•¥
3. **è¿ç®—ç¬¦åˆ†ç»„**: æä¾›è¿ç®—ç¬¦åˆ†ç»„åŠŸèƒ½,å¦‚ `ARITHMETIC_OPS`ã€`LOGIC_OPS` ç­‰,ç®€åŒ–é…ç½®
